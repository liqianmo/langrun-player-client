name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        python -m PyInstaller --onefile --windowed --name="朗润播放器客户端_独立版" 朗润播放器客户端_独立版.py
    
    - name: Create release package
      run: |
        mkdir "朗润播放器客户端_独立版_Windows发布包"
        copy "dist\朗润播放器客户端_独立版.exe" "朗润播放器客户端_独立版_Windows发布包\"
        
        echo @echo off > "朗润播放器客户端_独立版_Windows发布包\启动朗润播放器.bat"
        echo chcp 65001 ^> nul >> "朗润播放器客户端_独立版_Windows发布包\启动朗润播放器.bat"
        echo echo 正在启动朗润播放器客户端... >> "朗润播放器客户端_独立版_Windows发布包\启动朗润播放器.bat"
        echo "朗润播放器客户端_独立版.exe" >> "朗润播放器客户端_独立版_Windows发布包\启动朗润播放器.bat"
        echo pause >> "朗润播放器客户端_独立版_Windows发布包\启动朗润播放器.bat"
        
        echo 展演号码,姓名,作品名称,媒体链接 > "朗润播放器客户端_独立版_Windows发布包\数据模板.csv"
        echo 001,张三,春天的故事,http://example.com/media1.mp3 >> "朗润播放器客户端_独立版_Windows发布包\数据模板.csv"
        echo 002,李四,夏日风情,http://example.com/media2.mp4 >> "朗润播放器客户端_独立版_Windows发布包\数据模板.csv"
        echo 003,王五,秋天的童话,http://example.com/media3.mp3 >> "朗润播放器客户端_独立版_Windows发布包\数据模板.csv"
        
        mkdir "朗润播放器客户端_独立版_Windows发布包\downloaded_media"
        
        echo 朗润播放器客户端 - Windows版使用说明 > "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo. >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo 特点：无需安装Python环境，绿色软件，双击即用 >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo. >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo 使用方法： >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo 1. 双击运行"朗润播放器客户端_独立版.exe" >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo 2. 点击"导入CSV文件"选择数据文件 >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo 3. 点击"开始下载"下载媒体文件 >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
        echo 4. 输入展演号码搜索或双击列表播放 >> "朗润播放器客户端_独立版_Windows发布包\使用说明.txt"
    
    - name: Upload Windows build
      uses: actions/upload-artifact@v3
      with:
        name: 朗润播放器客户端_独立版_Windows
        path: 朗润播放器客户端_独立版_Windows发布包/
    
    - name: Create ZIP package
      run: |
        powershell Compress-Archive -Path "朗润播放器客户端_独立版_Windows发布包" -DestinationPath "朗润播放器客户端_独立版_Windows_v1.0.zip"
    
    - name: Upload ZIP package
      uses: actions/upload-artifact@v3
      with:
        name: 朗润播放器客户端_独立版_Windows_ZIP
        path: 朗润播放器客户端_独立版_Windows_v1.0.zip
